![image-20220313151051966](E:\MarkDown\picture\image-20220313151051966.png)
![image-20220313152143485](E:\MarkDown\picture\image-20220313152143485.png)

# 3.人体姿态估计的无偏数据处理 

在人体姿态估计中，数据处理涉及**不同坐标系之间的转换**和**不同关键点格式**之间的转换。下面，我们将分别从这两个方面（即无偏坐标系转换和无偏关键点格式转换）详细介绍我们的无偏数据处理方法。 

## 3.1 Unbiased Coordinate System Transformation无偏坐标系转换

由于这是一个新的话题，对社区来说相当模糊，为了澄清和合理的陈述，无偏坐标系转换的概念是从基础上构建的。我们首先提出了连续空间中数据的统一定义。在此基础上，介绍了坐标系变换的概念和无偏目标。在构建人体姿势估计问题中涉及的坐标系之间的通用组合变换之前，我们在一些基本操作（即裁剪、调整大小、旋转和翻转）中设计坐标系变换（即源图像坐标系、网络输入坐标系和网络输出坐标系）。随后，我们通过数学推理验证了所设计坐标系转换管道的无偏性。最后，为了展示有缺陷的坐标系如何影响研究界，我们分析了一些有偏见的数据处理方法，并深入研究了一些已报道的技术和最新技术中使用的未报告技巧背后的理论。 

### 3.1.1 连续空间中数据的统一定义

图像矩阵和目标关键点坐标是人体姿态估计问题的主要数据。图像以离散格式存储和处理，但关键点坐标是在连续空间中定义、处理和评估的。为了避免坐标系转换途径中的精度下降，需要一个统一的范例来统一分析和处理坐标系转换问题中的不同数据。
这里定义的样本点的大小是无限小的，图像的语义意义区域的大小是用单位长度计算的。因此，我们下面讨论的图像大小（即，宽度为w，高度为h）不同于图像矩阵的分辨率，后者在常识中广泛用于定义图像大小。从形式上讲，它们之间的关系如下：（wp，以像素为单位的变量；w以单位长度为单位的变量）
<img src="E:\MarkDown\picture\image-20220312093857495.png" alt="image-20220312093857495" style="zoom:80%;" />

### 3.1.2 坐标系变换的概念 

s为源坐标系，d为目标坐标系![image-20220312094035498](E:\MarkDown\picture\image-20220312094035498.png)<img src="E:\MarkDown\picture\image-20220312094007553.png" alt="image-20220312094007553" style="zoom:70%;" />
图像矩阵中内容的变换可以表示为：（p代表position，这里等式右边表示对T-1pd这个点 ，也就是左图中非整数的绿色的点进行Is操作
<img src="E:\MarkDown\picture\image-20220312094105694.png" alt="image-20220312094105694" style="zoom:70%;" />

等式3意味着，我们通过将位置pd的颜色设置为与源图像中位置<img src="E:\MarkDown\picture\image-20220312094430409.png" alt="image-20220312094430409" style="zoom:80%;" />的颜色相同，使图像在语义上与目标坐标系中的注释关键点保持一致.<img src="E:\MarkDown\picture\image-20220312101251291.png" alt="image-20220312101251291" style="zoom:80%;" />通常不是整数，因此<img src="E:\MarkDown\picture\image-20220312101424544.png" alt="image-20220312101424544" style="zoom:80%;" />应使用有效的周围点（即图3中的紫色点)通过双线性插值计算。 由于我们只有图像平面的采样结果(即图像矩阵)，插值是减少图像变换精度下降的最佳方法，但不能彻底解决这一问题。 因此，由于插值造成的精度下降是不可逆转和逐渐累积的， 我们的原则是，在设计坐标系转换途径(pipeline)时，在其中进行的插值越少越好。 

### 3.1.3 无偏目标(The Targets of  Unbias)

无偏是坐标系变换设计的一个目标，它包括两个方面：一是在变换后保持语义的一致性。语义对齐意味着不同数据（即图像和关键点位置）之间的位置相对性保持不变（例如，目标空间中鼻子的注释位置仍然精确位于目标空间中描述的图像中鼻子的位置）。这是通过保持方程2和方程3中的变换矩阵相同来保证的。 另一个方面是在假设网络具有完善的学习能力的前提下，使预测结果与gt完全一致。换句话说，我们希望网络的学习能力是导致精度下降的唯一原因，并且坐标转换途径的设计没有任何会导致精度下降的缺陷。接下来，我们将详细介绍无偏坐标系转换途径，并证明其无偏性质。

### 3.1.4 初等运算中的坐标系变换

人体姿势估计中的坐标系变换源自一些基本操作，如裁剪、调整大小、旋转和翻转。 


**Cropping**
![image-20220312123409278](E:\MarkDown\picture\image-20220312123409278.png)
如图4所示，**裁剪**是根据源坐标系ROI=（bxs，bys，bws，bhs）中定义的特定感兴趣区域（ROI）进行的，其中（bxs，bys）表示其中心位置，（bws，bhs)表示其宽度和高度。目标坐标系可以通过将源坐标系的原点移动到ROI的左上角来获得。因此，转换矩阵应设计为： 
<img src="E:\MarkDown\picture\image-20220312123744371.png" alt="image-20220312123744371" style="zoom:67%;" />

**Resizing**
<img src="E:\MarkDown\picture\image-20220312124253454.png" alt="image-20220312124253454" style="zoom:80%;" />
如图5所示，调整大小只会更改采样策略，并保持图像的语义常量与源相同。我们使四角采样点与源四角采样点语义对齐，并让其他采样点均匀分布在四角分割的区域中。因此，唯一改变的是坐标系的单位长度，变换矩阵应设计为： 
<img src="E:\MarkDown\picture\image-20220312124402436.png" alt="image-20220312124402436" style="zoom:80%;" />

**Rotating**
<img src="E:\MarkDown\picture\image-20220312124651223.png" alt="image-20220312124651223" style="zoom:60%;" />
如图6所示，旋转是根据旋转中心进行的，旋转中心总是被设置为特定ROI的中心，而不是坐标系的原点。该设计旨在保持ROI的中心位置不变（即（bxs，bys）=（bxd，byd)(上右坐标系中ROI的中心点)）。例如，ROI指的是自上而下范例中人类实例的边界框，以及自下而上范例中的整个图像。因此，变换矩阵应设计为三种基本变换的组合：(先是前两个小图，Y轴折上去再将中心点移动到XY轴原点，对应最后一个矩阵；再是图2到3，对应第二个矩阵；再是图3到4，将Y轴翻转回去，再移动中心点回原位置，对应第一个矩阵)
<img src="E:\MarkDown\picture\image-20220312125016999.png" alt="image-20220312125016999" style="zoom:80%;" />

**Flipping**
![image-20220312132135593](E:\MarkDown\picture\image-20220312132135593.png)
如图7所示，翻转通常以x=ws/2为镜像，水平交换图像的内容。因此，转换矩阵应设计为： 
<img src="E:\MarkDown\picture\image-20220312132235622.png" alt="image-20220312132235622" style="zoom:67%;" />

### 3.1.5 公共坐标系转换

![image-20220312132648268](E:\MarkDown\picture\image-20220312132648268.png)
源图像空间（s）、网络输入图像空间（i）和网络输出图像空间（o）
在训练过程中，首先根据特定的ROI（bxs、bys、bws、bhs）和旋转角度θ将数据从源图像坐标系转换为网络输入坐标系。一些基本操作是有序进行的：
![image-20220312132455685](E:\MarkDown\picture\image-20220312132455685.png)然后我们进行组合转换：
![image-20220312132733689](E:\MarkDown\picture\image-20220312132733689.png)
等式9不仅集成了裁剪和调整大小等必要的变换，还集成了可选的增强（Tflip于随机翻转，Trotating用于随机旋转，Tcroping用于半身和随机裁剪)用于人体姿势估计器训练。裁剪和调整大小是必要的，而翻转和旋转是可选的。将网络输入空间中的图像矩阵设置为网络输入，我们在网络输出空间中得到推理结果:（N表示Networks
<img src="E:\MarkDown\picture\image-20220312191906179.png" alt="image-20220312191906179" style="zoom:70%;" />
通过简单的调整大小操作，标注同时从网络输入空间转换为网络输出空间：（将标签gt转换到输出空间作为监督
<img src="E:\MarkDown\picture\image-20220312192304966.png" alt="image-20220312192304966" style="zoom:80%;" />
网络输出空间中的ko作为监督： 
<img src="E:\MarkDown\picture\image-20220312192531190.png" alt="image-20220312192531190" style="zoom:67%;" />
<img src="E:\MarkDown\picture\image-20220312192600204.png" alt="image-20220312192600204" style="zoom:67%;" />
这意味着网络不仅学习从图像矩阵 Ii 到关键点位置 ki 的映射，还学习在方程式11中定义的变换Ti→o的映射。 

在测试过程中，只需将图像矩阵从源图像坐标系转换到网络输入坐标系，并进行必要的初等变换，这些变换应与训练过程中的变换一致
<img src="E:\MarkDown\picture\image-20220312193336868.png" alt="image-20220312193336868" style="zoom:80%;" />
然后将等式10中的网络输出通过逆变换转换回源图像坐标系
<img src="E:\MarkDown\picture\image-20220312193619145.png" alt="image-20220312193619145" style="zoom:80%;" />

以方程式13为假设，并考虑方程式11、方程式14、方程式15，我们得到以下相同关系： 
<img src="E:\MarkDown\picture\image-20220312194855624.png" alt="image-20220312194855624" style="zoom:80%;" />
这一推论证明了源图像空间中的结果与gt完全相等，这意味着上述设计的数据转换途径是无偏的，不会涉及系统误差。 



当在测试过程中使用翻转集成时，通过在网络输入空间中执行翻转变换来获得翻转图像： 
![image-20220312212351618](E:\MarkDown\picture\image-20220312212351618.png)

我们有了网络预测<img src="E:\MarkDown\picture\image-20220312213121664.png" alt="image-2022031223121664" style="zoom:50%;" />，随后在网络输出空间中翻转回来： 
<img src="E:\MarkDown\picture\image-20220312213226140.png" alt="image-20220312213226140" style="zoom:80%;" />

以方程式13为假设，并考虑方程式11、方程式17和方程式18， <img src="E:\MarkDown\picture\image-20220312213523150.png" alt="image-20220312213523150" style="zoom:70%;" /><img src="E:\MarkDown\picture\image-20220312213553453.png" alt="image-20220312213553453" style="zoom:67%;" />

我们得出以下关系：![image-20220312213709871](E:\MarkDown\picture\image-20220312213709871.png)

这个推论证明，在网络输出空间中，翻转图像的结果与原始图像的结果是一致的。通过考虑等式16，源图像空间中翻转图像的结果也与gt一致，不会涉及系统误差。方程16和方程19的建立保证了坐标系转换途径中的无偏性。在下一小节中，它们将用作检查偏置坐标系转换途径的指南。 

### 3.1.6 有偏坐标系变换的判断（为什么像素为单位会出现有偏

在大多数最新技术[24]、[25]、[26]、[27]、[28]中，坐标系变换管道中的偏差问题源于在执行调整大小变换时使用以像素计的分辨率（wps，hps）而不是以单位长度测量的大小（ws，hs）。因此，它将等式16和等式19变为： 
(将wo等变为了wpo)![image-20220312220126401](E:\MarkDown\picture\image-20220312220126401.png)

下图是19式，用来和21式对比（改变了·中间那个矩阵）![image-20220312220229528](E:\MarkDown\picture\image-20220312220229528.png)

这里倒数第三个等式，是通过带入wi=wpi-1和wo=wpo-1得到，然后将其展开为倒数第二式，再![image-20220312215907288](E:\MarkDown\picture\image-20220312215907288.png)

其中s=wpi/wpo是描述网络特征尺寸变化的跨步系数。这里，ˆks仍然等于ks，表明上述修改不会改变坐标系转换pipeline<img src="E:\MarkDown\picture\image-20220312221848882.png" alt="image-20220312221848882" style="zoom:80%;" />中的无偏属性，且不会影响预测结果的精度。然而，当在测试过程中采用翻转操作时（对应19和21），ˆk‘o与ˆko并不完全对齐，并且在Oo-Xo方向存在1-s/s的偏移量。以ˆko为参考，1−s/s是网络输出空间中结果ˆko'的预测误差。如果我们直接将ˆko'和ˆko作为大多数现有工作的平均值： 
<img src="E:\MarkDown\picture\image-20220312222504281.png" alt="image-20220312222504281" style="zoom:80%;" />

the final error in Oo-Xo direction is:
![image-20220312222543992](E:\MarkDown\picture\image-20220312222543992.png)

式中，ˆko为gt，因为等式20证明它是无偏的。这种预测误差的大小如此之大，以至于性能将大幅下降。在现有技术中，有一些经验补救措施可以解决这一错误，可以分为两类：直接补偿或使用更高分辨率。 
因为错误|1−s/2s|有一个由步幅系数决定的固定比例，直接补偿是有效的，是大多数最先进的自上而下方法[24]、[25]、[27]、[28]、[29]中的补救方法。例如，SimpleBaseline[24]、HRNet[25]和DarkPose[29]在执行平均操作以抑制此错误之前，根据经验将翻转图像的结果在Oo Xo方向上移动一个像素： （其中移动一个像素的操作就是乘下面这个矩阵
<img src="E:\MarkDown\picture\image-20220312222853303.png" alt="image-20220312222853303" style="zoom:80%;" />

这样，最终的误差可以减少到 <img src="E:\MarkDown\picture\image-20220312223205593.png" alt="image-20220312223205593" style="zoom:67%;" />

当s>2时 ，e(x)′o<e(x)o，这在大多数现有方法中是有意义的。直观地说，作为推理的结果，对网络输出空间中的e(x)′o进行额外补偿可以使现有工作的结果更加准确。我们将在消融研究中验证这一点 

此外，当用等式15将e(x)'o映射回源图像坐标系(Os-XsYs)时，我们有： ![image-20220312230816183](E:\MarkDown\picture\image-20220312230858139.png)
![image-20220312231753166](E:\MarkDown\picture\image-20220312231753166.png)![image-20220312230912736](E:\MarkDown\picture\image-20220312230912736.png)

其中bws在推理过程中是固定的。等式26意味着更高的网络输入分辨率有助于抑制由e(x)’s引起的预测误差。换句话说，现有的自顶向下方法从更高的输入分辨率中受益更多，并且从更低的输入分辨率中遭受更大的精度损失。 

在不移动网络输出空间中的一个像素的情况下，我们有： 
![image-20220312231904073](E:\MarkDown\picture\image-20220312231904073.png)

这意味着更高的输入分辨率和更高的输出分辨率都有助于抑制这种错误。这对HigherNet[26]的性能提升起到了最大的作用。根据经验，HigherNet建议使用更高的输出分辨率来追求高精度，但同时在网络推断和后处理方面都要付出巨大的延迟。相比之下，无偏数据处理提供了一个自由的访问，以实现类似的性能改善与低输出分辨率。除了使用更高的输出分辨率，HigherNet还使用另一种未报告的操作，将网络输出调整为与网络输入一样高的分辨率。该操作还碰巧弥补了坐标系转换途径偏差造成的错误，并有利于HigherNet结构的性能，但代价是在后处理中增加了延迟。通过消融试验，我们将表明，当坐标系转换管道无偏时，该操作是多此一举的，因为它将涉及额外的误差，并通过在调整大小操作中执行额外的插值来改变网络输出的分布。 



## 3.2 Unbiased Keypoint Format Transformation 无偏关键点格式转换(坐标->heatmap)

> **坐标和heatmap之间的转换即编解码过程，这里的无偏指公式29，即对关键点坐标编码再解码后还能恢复原坐标。这里介绍了两种方法，法一是G-RMI，法二是DARK**

### 3.2.1 无偏关键点格式转换的概念

由于关键点坐标不是卷积网络研究的最佳格式，因此提出了直观上更合适的热图格式，并迅速被证明是有效的。关键点格式变换是指关键点坐标和热图之间的变换，在最先进的方法中广泛使用。在一般意义上，编码表示从坐标格式到热图格式的转换，而解码表示逆转换。 

<img src="E:\MarkDown\picture\image-20220313095814492.png" alt="image-20220313095814492" style="zoom:80%;" />

关键点格式转换无偏设计的目标是避免编码和解码转换的精度下降。作为一个既定目标，我们应该： 
<img src="E:\MarkDown\picture\image-20220313095949064.png" alt="image-20220313095949064" style="zoom:80%;" />

### 3.2.2 无偏关键点格式转换

在本小节中，我们将介绍两种无偏关键点格式转换范式，并同时展示它们的无偏特性。 

**Combined classification and regression format组合分类和回归格式 **
其灵感来源于物体检测[Faster RCNN]中的工作，其中锚(anchor)被用于预测边界框，并首次在[G-RMI]中提出。我们在这里进行了详细介绍，并做了一些修改。在训练过程中，每个带注释的关键点k=（m，n）通过以下方式编码：
![image-20220313101201541](E:\MarkDown\picture\image-20220313101201541.png)
其中C是分类热图，在目标检测中充当锚，用于初步定位关键点。 r是一个超参数，表示被归类为正的区域半径。由偏移向量组成的X和Y是保留剩余定位信息的回归热图。然后，损失设计为：(cls分类，reg回归)
![image-20220313101644590](E:\MarkDown\picture\image-20220313101644590.png)

其中Loss_reg中的C定义了感兴趣的区域，这意味着我们只需要了解分类标签为真的区域之间的偏移量。该网络在培训过程中得到了优化，因此，我们有： 
<img src="E:\MarkDown\picture\image-20220313102158245.png" alt="image-20220313102158245" style="zoom:80%;" />

然后在测试处理中，通过以下方式解码预测： 
<img src="E:\MarkDown\picture\image-20220313102226409.png" alt="image-20220313102226409" style="zoom:80%;" />

其中，最高响应ˆkh的位置首先定位，然后利用预测的偏移量进行更新。通过考虑等式30和等式32，我们得到： 
<img src="E:\MarkDown\picture\image-20220313102428195.png" alt="image-20220313102428195" style="zoom:80%;" />

这意味着在关键点格式转换管道中不涉及系统误差，并且实现了等式29中的无偏目标。 

**Classification format分类格式**
在大多数最先进的技术中广泛使用，其中分类热图仅用于高斯分布： 
<img src="E:\MarkDown\picture\image-20220313103032778.png" alt="image-20220313103032778" style="zoom:80%;" />

该网络在培训过程中得到了优化，因此，我们有：
<img src="E:\MarkDown\picture\image-20220313103118042.png" alt="image-20220313103118042" style="zoom:80%;" />

在测试过程中，我们介绍了DARK[29]的解码方法，该方法通过搜索高斯分布的中心，将分类热图解码为关键点坐标，其中一阶导数等于零： 
![image-20220313103149998](E:\MarkDown\picture\image-20220313103149998.png)

其中，ˆC‘和ˆC“是ˆC的一阶导数和二阶导数（即Hessian）。根据[29]，泰勒级数近似引起的精度降低可以忽略不计，并且ˆk理论上接近k，这与无偏的目的相匹配。 

### 3.2.3 Analysis of Biased Keypoint Format Transformation有偏关键点格式转换的分析

> **这里不是很懂**

我们以SimpleBaseline[24]、HRNet[25]和HigherRnet[26]中使用的关键点格式转换方法为例，研究了有偏数据格式转换的影响。关键点被编码到具有高斯分布的分类热图中，如等式35所示，但通过次优方法解码：
<img src="E:\MarkDown\picture\image-20220313103428729.png" alt="image-20220313103428729" style="zoom:80%;" />

根据等式35中的编码，我们有：(其中ceil为向上取整，正数加一，负数抹后；floor为向下取整，正数抹掉，负数-1.3变为-2）
<img src="E:\MarkDown\picture\image-20220313103456393.png" alt="image-20220313103456393" style="zoom:80%;" />

例如，预测O−X方向中的坐标具有以下分布： 
<img src="E:\MarkDown\picture\image-20220313103602093.png" alt="image-20220313103602093" style="zoom:80%;" />

假设k在像平面上均匀分布（m − Floor(m) and n − Floor(n)都是区间[0, 1)内的均匀分布），每个方向上的均匀误差为![image-20220313103854876](E:\MarkDown\picture\image-20220313103854876.png)

映射E(|m− ˆm|)返回到源图像坐标系（Os-XsYs），使用等式15，我们得到：<img src="E:\MarkDown\picture\image-20220313104036718.png" alt="image-20220313104036718" style="zoom: 50%;" />

考虑误差E(|m− ˆm|)和E(|n− ˆn|)，带有偏差数据形式转换的方法受益于更高的网络输出分辨率。这一部分也有助于提高HigherHRnet的性能。 

### 3.2.4有偏坐标系变换和有偏关键点格式变换的联合分析

等式25中的误差oe(x)'=1/2s对解码结果分布有影响。对于特定的步幅系数s=4，考虑到等式21，我们得到： 
<img src="E:\MarkDown\picture\image-20220313140331782.png" alt="image-20220313140331782" style="zoom:80%;" />

因此，Oo-XoYo中翻转图像的预测热图变为ˆC'o=C(x，y，m+0.25，n)，平均热图分布变为：
<img src="E:\MarkDown\picture\image-20220313140510604.png" alt="image-20220313140510604" style="zoom:80%;" />

我们用一个近似值来简化下面的分析。最后，误差oe(x)'=1/2s导致等式39中结果分布的变化： 
<img src="E:\MarkDown\picture\image-20220313140644159.png" alt="image-20220313140644159" style="zoom:80%;" />
并且Oo-Xo方向的预期误差仅扩大了1/32单位长度，即E（| m− ˆm |）=5/32≈ 0.156及一个更大的方差V(| m− ˆm |)=37/3072≈ 0.012. 

考虑到误差oe(x)=s−1/2s在等式23中，等式39中解码结果的分布将变为： 
<img src="E:\MarkDown\picture\image-20220313141458728.png" alt="image-20220313141458728" style="zoom:80%;" />

并且Oo-Xo方向的预期误差扩大了1/4单位长度，达到E（| m− ˆm |）=3/8=0.375以及一个更大的方差V（|m− ˆm |）=1/48≈ 0.0208. 与oe(x)=s−1/2s=0.375相比，有偏解码方法会产生偏差，这将对最终性能产生额外的负面影响。值得注意的是，实际误差比上述分析更复杂，因为等式44中的近似值也会对误差产生影响。 

# 5.CONCLUSION

本文定量分析了人体姿态估计中常用的有偏数据处理方法。有趣的是，我们发现，标准坐标系转换和关键点格式转换中的系统误差耦合在一起，显著降低了自上而下和自下而上模式下人体姿势估计器的性能。研究界陷入了一个陷阱，随后产生了许多次优的补救措施。本文提出了一种原则性的无偏数据处理（UDP）策略，包括无偏坐标系转换和无偏关键点格式转换。UDP不仅突破了人体姿态估计的性能边界，而且通过消除了在有缺陷的数据处理途径中形成的陷阱，为研究界提供了可靠的基线。 







