![image-20220311104937326](E:\MarkDown\picture\image-20220311104937326.png)

数据转换是指在源图像、网络输入和输出等不同坐标系之间转换关键点位置。在这个过程中，大多数最先进的方法使用像素来测量图像的大小，导致在推理中使用翻转策略时结果不一致。[Simple baselines、HRNet、Darkpose]在网络输出坐标系中，根据经验将翻转图像的结果移动1个像素，以抑制预测误差。[CPN、MSPN]通过在网络输入坐标系中将平均结果移动2个像素来实现类似效果。这些补偿是有效的，但效果有限。HigherHRnet建议使用更高的网络输出分辨率，并进行了一些未报告的补偿试验来在baseline上取得巨大优势。

验证一下HR和cpn代码

# 3.人体姿态估计的无偏数据处理 

源图像空间（上标s）、网络输入图像空间（上标i）和网络输出图像空间（上标o）。 
上标p表示长度是以像素为单位测量，否则，长度以与相应空间相关的单位长度计量。图像矩阵和相应的关键点坐标分别用I和k表示。带有hatˆk的符号是相应地面真值标签k的网络预测结果。

if the size of an image is (pw,ph) measured by pixel,its size in the continuous image plane is (pw−1,ph−1)如何理解：看论文大图，8像素的图像在连续空间里只占7个单位长度

## 3.1数据转换

### 3.1.1标准数据转换的分析

数据转换意味着在不同坐标系之间转换关键点位置，例如裁剪、旋转、调整大小和翻转。现有的姿态估计方法采用像素来测量图像的大小，这是一个离散的空间。然而，对于定位任务，像素是图像平面（即连续空间）中的一些采样点。例如，如果图像的大小是按像素测量的（pw，ph），则其在**连续图像平面中的大小是(pw−1,ph−1).** 当在推理过程中执行事实上的标准翻转策略时，使用像素作为测量将显著降低性能。

用标准方法获得的网络输入图像空间中的关节点坐标ik为对源图像空间中的坐标进行变换（wi  hi 为输入图像大小，源空间中xb,yb为中心，wb,hb为原空·间大小）这里后面部分的意思是将中心点移动到源图像的中心点位置

![image-20220309211207208](E:\MarkDown\picture\image-20220309211207208.png)
![image-20220310100537515](E:\MarkDown\picture\image-20220310100537515.png)其中cθ和sθ分别表示cos（θ）和sin（θ）。θ是旋转增量中的角度。左边部分为旋转矩阵

网络输入矩阵中的每个像素可以回溯到源图像，如下所示，其中左边就是旋转矩阵的逆矩阵，右边坐标平移部分如图![image-20220309211258604](E:\MarkDown\picture\image-20220309211258604.png)经过前面的转换，I与S的中心点位置一样，只是进行了旋转和缩放![image-20220310110525672](E:\MarkDown\picture\image-20220310110525672.png)

如图2所示，标准增强样本可等效为以下两个步骤产生的结果： 
1、从源图像裁剪感兴趣的区域，并将其调整为（pwi+1，phi+1）的形状（图2中网络输入空间中的绿色框）。 
2、在右边缘和下边缘将上述结果裁剪1个像素，生成大小为（pwi，phi）的图像

> **这里如何理解呢，就是在S空间中，我们裁剪到的感兴趣区域的像素可能是小数的，调整大小后在下和右的边缘部分会对像素进行取整，造成像素的裁剪**

该方法生成的训练样本在语义上与原始样本保持一致（即姿势标注仍处于正确位置）。在生成尺寸为（pwo，pho）的热图中的ground-truth时，标准方法通过跨步系数s=pwi/pwo=phi/pho变换输入关键点位置：<img src="E:\MarkDown\picture\image-20220309213622031.png" alt="image-20220309213622031" style="zoom: 70%;" />
其中ok是网络输出热图中的关键点坐标。

在推理阶段，标准方法通过以下方式将预测结果oˆk映射到源图像空间：![image-20220309212025427](E:\MarkDown\picture\image-20220309212025427.png)其中sˆk是源图像空间中关键点的**最终预测位置**。这种转换也可以等效地表述为两个步骤：
1.将网络输出热图的大小从（pwo，pho）填充到（pwo+1，pho+1)（图2中网络输出空间中的绿色框)
2.将上述填充热图映射到源图像中相应的边界框。 

> **不明白这里为什么要padding，为了和前步 S->I 中发生了1像素的crop对应？**

理想情况下，预测结果sˆk等于sk。然而，当使用翻转策略时，结果会有偏差。标准方法翻转网络输入图像，然后关键点ik位于： （这里(-1，1)部分表示翻转，然后向上平移pwi-1） 

> **这里怎么又平移wi-1了？前步 S->I 中是wi+1裁剪到wi啊，除非这里理解的是绿色框的长wi，这里整个绿色框翻转后就是移动wi-1了**

![image-20220309212150532](E:\MarkDown\picture\image-20220309212150532.png)

其中，如果k是翻转图像中关键点ik的对应位置。根据方程式3，标准方法预测输出热图中的关键点如下： ![image-20220309213631643](E:\MarkDown\picture\image-20220309213631643.png)

然后，f代表翻转，翻转图像的最终结果oˆkf可以通过反向翻转获得：

> **还是不明白**

![image-20220309213655461](E:\MarkDown\picture\image-20220309213655461.png)
![image-20220311153223865](E:\MarkDown\picture\image-20220311153223865.png)oˆkf与oˆk并不完全一致，并且有一个偏移量−(s−1/s)在Oo-Xo方向

如果我们直接平均oˆk和oˆkf ![image-20220309213831855](E:\MarkDown\picture\image-20220309213831855.png)
Oo Xo方向上的相应错误为：
![image-20220309213900516](E:\MarkDown\picture\image-20220309213900516.png)

标准方法(Simple baselines)在平均操作之前将翻转的结果移动1像素，以缩小此间隙： 
![image-20220309213933342](E:\MarkDown\picture\image-20220309213933342.png)
通过这种方式，最终误差可以减少到<img src="E:\MarkDown\picture\image-20220309214346494.png" alt="image-20220309214346494" style="zoom:50%;" />

当s>2时 ，oe（x）′<oe(x)，这在大多数现有方法中是有意义的。直观地说，oe(x)′的补偿可以使结果更准确。然而，这种直接补偿的实际贡献非常有限。我们将在第3.2节中详细分析这种效率低下的情况。此外，当将oe(x)′映射回源图像坐标系（Os XsYs)并考虑θ=0的等式4时，我们有： ![image-20220310213656800](E:\MarkDown\picture\image-20220310213656800.png)![image-20220309214854101](E:\MarkDown\picture\image-20220309214854101.png)
其中swb在推理过程中是固定的。因此，较大的网络输入大小有助于抑制由oe（x)′引起的预测误差。换句话说，标准方法从更高的输入分辨率中获益更多，而从更低的输入分辨率中损失更多的精度。 

### 3.1.2提出的数据转换 

采用单位长度作为图像大小的度量标准，即在特定空间中两个相邻像素之间的距离。基于此概念，网络输入空间中的地面真值标签ik应通过以下转换获得：(将pwi变为了pwi-1)
![image-20220310214341059](E:\MarkDown\picture\image-20220310214341059.png)![image-20220310215009561](E:\MarkDown\picture\image-20220310215009561.png)

在生成热图上的地面真值标签时，我们应该在连续空间中测量地图，并利用因子t 
![image-20220310215207517](E:\MarkDown\picture\image-20220310215207517.png)

这样，翻转图像oˆkf的结果与原始结果oˆk完全一致。最后，应通过以下逆变换获得源图像空间中的预测sˆk： 
![image-20220310215315081](E:\MarkDown\picture\image-20220310215315081.png)

## 3.2编解码

上述分析是在关键点位置和热图之间的编解码过程精确（即ˆk=k）的前提下进行的。然而，这一前提条件并不适用于标准方法[32,26]。在下文中，我们将首先研究系统误差（即|ˆk− k |）中，并展示这种系统误差如何影响上述结论。本小节仅使用网络输出热图坐标系Oo XoYo。 

### 3.2.1 标准编解码分析

#### 标准编码

形式上，给定热图中的地面真值标签点k=（m，n），标准方法首先量化标签点坐标，以获得整型标签坐标kq： （这里R代表取整<img src="E:\MarkDown\picture\image-20220310215845439.png" alt="image-20220310215845439" style="zoom:80%;" />

生成以kq为中心的热图（x、y表示heatmap中每个元素的坐标，δ表示固定的空间方差)
<img src="E:\MarkDown\picture\image-20220310220058104.png" alt="image-20220310220058104" style="zoom:80%;" />

#### 标准解码

<img src="E:\MarkDown\picture\image-20220310221000295.png" alt="image-20220310221000295" style="zoom:50%;" />为经过训练的网络预测，在<img src="E:\MarkDown\picture\image-20220310221042278.png" alt="image-20220310221042278" style="zoom:50%;" />的理想条件下，   标准方法通过首先定位最高响应来解码： <img src="E:\MarkDown\picture\image-20220310221131607.png" alt="image-20220310221131607" style="zoom:50%;" />
根据方程式17和方程式18（上面两个式子），热图x方向上的预测关键点位置为：(其中C为向上取整(ceil，正数加一，负数抹后)，F为向下取整(floor，正数抹掉，负数-1.3变为-2)
<img src="E:\MarkDown\picture\image-20220310224407592.png" alt="image-20220310224407592" style="zoom:50%;" />
![image-20220311110031063](E:\MarkDown\picture\image-20220311110031063.png)

![image-20220311104701130](E:\MarkDown\picture\image-20220311104701130.png)

由于ˆkq的理想位置是kq，假设k在图像平面上均匀分布，每个方向上的预期误差是E(|m− ˆmq |）=E（| n− ˆnq |）=1/4单位长度，方差为V（| m− ˆmq |）=V（|n− ˆnq |）=1/48。 为了减少这种误差，标准方法根据响应梯度将ˆkq在每个方向上移动0.25单位长度： <img src="E:\MarkDown\picture\image-20220311092401242.png" alt="image-20220311092401242" style="zoom: 67%;" />

∇ 是梯度算子。此操作将解码结果分布更改为：
<img src="E:\MarkDown\picture\image-20220311092443061.png" alt="image-20220311092443061" style="zoom:67%;" />
每个方向的预期误差可以减小到E（| m− ˆm |）=E（|n− ˆn |）=1/8单位长度，方差为V（| m− ˆm |）=V(|n− ˆn|)=1/192≈0.0052. 
映射E（| m− ˆm |）时回到源图像坐标系（Os-XsYs），考虑θ=0的等式4(Wb*s/Wi)，我们得到：<img src="E:\MarkDown\picture\image-20220311092829391.png" alt="image-20220311092829391" style="zoom:67%;" />

考虑误差E（| m− ˆm |）和E（|n− ˆn |），带有固定跨步因子s的标准方法[32,26]也可以受益于更高的网络输入分辨率。

第3.1节中由推断出翻转引起的测试误差oe（x）′=1/2s对误差分布有影响。在特定的跨步系数s=4 [标准方法32,26] 的情况下，预测的热图变为ˆH′=H（x，y，m+0.125，n+0.125），导致解码结果分布如下： <img src="E:\MarkDown\picture\image-20220311093349004.png" alt="image-20220311093349004" style="zoom:67%;" />
而Oo-Xo方向的预期误差仅扩大了1/32单位长度，即E（| m− ˆm′|）=5/32，方差为V（|m− ˆm′|）=37/3072≈ 0.012.. 解码误差占主导地位，数据转换误差对最终预测性能影响不大。如果只修正数据转换误差，其贡献可能小于训练过程中的不稳定性。 

从统计角度来看，上述对ˆm’的直接补偿− 1/2s单位长度可以完全消除oe(x)′引起的影响，如E(|m− (ˆm′− 0.125)|)=1/8正好等于E（|m−ˆm|)，并且V (|m − ( ˆm′ − 0.125)|)=1/192正好等于V（|m− ˆm |）。这种补偿是有效的，但有限，我们仍然需要其他编码-解码方法来消除标准方法造成的统计误差。 

### 3.2.2 提出的编解码

受G-RMI的启发，我们介绍了一种组合分类和回归编码解码方法，其误差预期值为零。每个gt标签点k=（m，n）被编码到一个heatmap中： <img src="E:\MarkDown\picture\image-20220311094209283.png" alt="image-20220311094209283" style="zoom:50%;" />
和两张偏移图<img src="E:\MarkDown\picture\image-20220311094253675.png" alt="image-20220311094253675" style="zoom:60%;" />

在解码过程中，我们首先使用高斯核K对热图进行滤波，使其在gt标记点附近产生最高响应。那么，最高分数的位置是： <img src="E:\MarkDown\picture\image-20220311094549007.png" alt="image-20220311094549007" style="zoom:67%;" />

⊗ 表示卷积运算，K是根据基于径向基函数生成的核：
<img src="E:\MarkDown\picture\image-20220311094803947.png" alt="image-20220311094803947" style="zoom:80%;" />

其中核大小为2N+1。最后，根据偏移图修改坐标： 
<img src="E:\MarkDown\picture\image-20220311094901379.png" alt="image-20220311094901379" style="zoom:80%;" />

其中K用于平滑两个预测的偏移图。aa这样，在理想条件下（即ˆH=H和ˆX=X和ˆY=Y），预测结果ˆk理论上等于gt真值k，理想情况下的预期误差为零。<img src="E:\MarkDown\picture\image-20220311095116829.png" alt="image-20220311095116829" style="zoom:60%;" />
